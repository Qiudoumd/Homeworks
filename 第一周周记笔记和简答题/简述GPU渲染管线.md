#### <u>**简述GPU渲染管线**</u>

#### 几何阶段

图元数据存储在GPU显存中，调用数据传输到**顶点着色器**，**顶点着色器**主要进行坐标的变换，对图元数据中的顶点进行处理和变换，将局部坐标转换到世界坐标、观察坐标和裁剪坐标等。

然后到**曲面细分着色器**，**曲面细分着色器**是渲染管线中的一个可选阶段，以图元为单位处理，能够生成更多的顶点和三角形，从而来提高模型的细节程度，生成更加光滑和细致的曲面。

数据传输到**几何着色器**，同样也是以图元作为输入，对其进行进一步的处理变换或者生成新的图元，可以用来改变图元的拓扑结构，实现复杂的几何效果。

**投影阶段**：投影会基于顶点着色器处理后的顶点位置，将三维的顶点投影到二维平面上，以便于在屏幕上显示。

**裁剪阶段**：用来确定哪些物体或物体的哪些部分在摄像机的可视范围内，将其他一些不在可视范围内的部分裁减掉，不做后续的处理，从而提高渲染的效率。

**屏幕映射**：将经过投影和裁剪后的坐标转换为屏幕上的实际像素坐标。根据屏幕的分辨率确定每个顶点在屏幕上的实际位置。

**GPU显存会存储处理过的顶点信息，为光栅化阶段提供数据支持。**



#### 光栅化阶段

**图元组装**：接受之前被处理然后存储在GPU显存中的顶点数据，主要作用是将顶点数据组装成图元，如点、线、三角形等。组装好的图元数据，会被传递到下一个阶段进行处理。

**三角形遍历**：主要用于确定屏幕上哪些像素位于三角形内部，找出屏幕上需要绘制三角形的像素区域，避免对无关像素进行处理，提高渲染效率，保证图形的准确性。同时，一旦确定了某个像素位于三角形内部，就会生成一个片元，其中包含了该像素对应的三角形的相关信息。

**片元着色器**：是一个用于计算每个片元最终颜色的程序。接受上一阶段传来的片元数据，根据片元的数据和程序中的算法，计算片元的颜色。也可以实现各种视觉特效，完成透明度的处理。

**逐片元操作**：主要对片元进行一系列的处理，以确定最终在屏幕上显示的像素值。

​                    **1.裁剪测试**：根据设定的裁剪区域，判断片元是否在该区域内，否则不进行处理

​                    **2.透明度测试**：根据片元的透明度值与设定的阈值进行比较，决定片元是否通过测试。

​                    **3.深度测试**：将片元的深度值与深度缓冲区中对应位置的深度值进行比较。如果片元的深度值小于深度缓冲区中的值，说明该片元在前面，应更新深度缓冲区并绘制该片元；否则，该片元被遮挡，不进行绘制。

​                    **4.模板测试**：通过将片元的模板值与模板缓冲区中的值进行比较，并根据设定的比较函数和操作来决定片元是否通过测试，以及是否更新模板缓冲区的值。

​                    **5.混合**：当片元通过前面的测试后，将其颜色与目标缓冲区中对应像素的颜色进行混合。混合的方式可以根据不同的需求进行设置，如透明度混合、加法混合、乘法混合等，以实现半透明效果、发光效果等。

​                    **6.抖动**：通过在颜色值上添加一些随机噪声来模拟更高的颜色精度，以减少颜色带的出现，使颜色过渡更加平滑。

经过逐片元操作后，确定了每个片元对于的屏幕像素和深度等信息，最终在屏幕上输出渲染图像







